name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  IMAGE_NAME: ghcr.io/grcteam-nova/egrc-app
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 7.0.x

    - name: Get Version
      id: get_version
      run: |
        VERSION=$(grep -oP '(?<=<Version>)[^<]+' Directory.Build.props)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Detected version: $VERSION"

    - name: Check if image exists
      id: check_image
      run: |
        echo "Checking for existing image: ${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
        if docker manifest inspect ${{ env.IMAGE_NAME }}:${{ env.VERSION }} > /dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi


    - name: Get current date
      id: datetime
      run: echo "now=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Alert Duplicate Version
      if: steps.check_image.outputs.exists == 'true'
      uses: appleboy/telegram-action@v0.1.1
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ‚õî **Erro de Vers√£o**
          
          A imagem **${{ env.IMAGE_NAME }}:${{ env.VERSION }}** j√° existe!
          
          Reposit√≥rio: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.event.head_commit.message }}
          Autor: ${{ github.actor }}
          Data/Hora: ${{ steps.datetime.outputs.now }}
          
          Por favor, incremente a vers√£o no arquivo .csproj antes de fazer o merge.

    - name: Exit if image exists
      if: steps.check_image.outputs.exists == 'true'
      run: exit 1

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore

    # - name: Test
    #   run: dotnet test --no-build --verbosity normal

    - name: Login to GitHub Container Registry
      if: github.event_name == 'push'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push Docker Image
      if: github.event_name == 'push'
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.IMAGE_NAME }}:${{ env.VERSION }},${{ env.IMAGE_NAME }}:latest
        build-args: |
          EGRC_API_URL_URL=${{ secrets.EGRC_API_URL_URL }}
          EGRC_COLLABORA_URL=${{ secrets.EGRC_COLLABORA_URL }}

    - name: Notify Success
      if: success() && github.event_name == 'push'
      uses: appleboy/telegram-action@v0.1.1
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          üöÄ **Deploy Realizado com Sucesso!**
          
          Nova vers√£o: **${{ env.VERSION }}**
          Imagem: `${{ env.IMAGE_NAME }}:${{ env.VERSION }}`
          
          Reposit√≥rio: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.event.head_commit.message }}
          Autor: ${{ github.actor }}
          Data/Hora: ${{ steps.datetime.outputs.now }}
          Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Tudo certo! üéâ

    - name: Notify Build Success (PR)
      if: success() && github.event_name == 'pull_request'
      uses: appleboy/telegram-action@v0.1.1
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ‚úÖ **Build de PR Sucesso!**
          
          Vers√£o testada: **${{ env.VERSION }}**
          
          Reposit√≥rio: ${{ github.repository }}
          Branch: ${{ github.head_ref }}
          Autor: ${{ github.actor }}
          Data/Hora: ${{ steps.datetime.outputs.now }}
          Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Pode fazer o merge! üëç

    - name: Notify Failure
      if: failure()
      uses: appleboy/telegram-action@v0.1.1
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          ‚ùå **Falha no Pipeline**
          
          Vers√£o: **${{ env.VERSION }}**
          
          Reposit√≥rio: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.event.head_commit.message }}
          Autor: ${{ github.actor }}
          Data/Hora: ${{ steps.datetime.outputs.now }}
          Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Verifique os logs no GitHub Actions. üò¢